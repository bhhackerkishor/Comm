<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TalkPair</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Basic styles for clarity */
    body {
      background: linear-gradient(145deg, #1a1c1f, #0c0d0f);
      color: #fff;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 30px 40px;
      text-align: center;
      width: 360px;
      box-shadow: 0 4px 30px rgba(0,0,0,0.3);
    }
    h1 { margin-bottom: 15px; }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .controls { display: flex; gap: 10px; margin-top: 10px; justify-content: center; }
    button {
      background: rgba(255,255,255,0.1);
      color: white;
      border-radius: 12px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s;
      min-width: 90px;
      border: none;
    }
    button.danger { background: #d93025; }
    #partner { font-weight: 600; color: #00c3ff; margin-top: 8px; }
    #status { margin-top: 15px; font-size: 14px; color: #aaa; min-height: 20px; }
    .ringing { animation: blink 1s infinite; color: #ffb300; }
    @keyframes blink { 50% { opacity: 0.3; } }
    #timer { margin-top: 10px; font-size: 13px; color: #ccc; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ™ï¸ TalkPair</h1>
    <input id="name" placeholder="Enter your name" />
    <div class="controls">
      <button id="register">Register</button>
      <button id="find">Find</button>
      <button id="end" class="danger" disabled>End</button>
      <button id="mute" disabled>ğŸ¤ Mic</button>
      <button id="speaker" disabled>ğŸ”Š Speaker</button>
    </div>
    <p id="partner"></p>
    <p id="status">Not connected</p>
    <p id="timer"></p>
  </div>

  <audio id="localAudio" autoplay muted></audio>
  <audio id="remoteAudio" autoplay></audio>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // Connect to your Node.js server
    const socket = io("https://server-09p9.onrender.com"); // Change in production if needed

    const nameInput = document.getElementById("name");
    const btnRegister = document.getElementById("register");
    const btnFind = document.getElementById("find");
    const btnEnd = document.getElementById("end");
    const btnMute = document.getElementById("mute");
    const btnSpeaker = document.getElementById("speaker");
    const statusEl = document.getElementById("status");
    const partnerEl = document.getElementById("partner");
    const timerEl = document.getElementById("timer");
    const localAudio = document.getElementById("localAudio");
    const remoteAudio = document.getElementById("remoteAudio");

    let pc = null, localStream = null, partnerId = null,
        isMuted = false, speakerOn = true, timer = null, callStart = null,
        pendingCandidates = [];

    async function resetConnection() {
      if (pc) {
        pc.ontrack = null;
        pc.onicecandidate = null;
        pc.close();
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      partnerId = null;
      btnEnd.disabled = true;
      btnMute.disabled = true;
      btnSpeaker.disabled = true;
      btnMute.classList.remove("active");
      btnSpeaker.classList.remove("active");
      btnMute.textContent = "ğŸ¤ Mic";
      btnSpeaker.textContent = "ğŸ”Š Speaker";
      remoteAudio.srcObject = null;
      partnerEl.textContent = "";
      isMuted = false;
      speakerOn = true;
      remoteAudio.muted = false;
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      timerEl.textContent = "";
      pendingCandidates = [];
    }

    async function initPeer() {
  pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  localAudio.srcObject = localStream;
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; };
  pc.onicecandidate = e => {
    if (e.candidate) socket.emit("signal", e.candidate);
  };
}


    function startTimer() {
      callStart = Date.now();
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        const diff = Math.floor((Date.now() - callStart) / 1000);
        const m = String(Math.floor(diff / 60)).padStart(2, "0");
        const s = String(diff % 60).padStart(2, "0");
        timerEl.textContent = `â±ï¸ ${m}:${s}`;
      }, 1000);
    }

    btnRegister.onclick = () => {
      const name = nameInput.value.trim();
      if (!name) return alert("Enter name first");
      socket.emit("register", name);
      statusEl.textContent = "âœ… Registered as " + name;
      btnRegister.disabled = true;
    };

    btnFind.onclick = async () => {
      await resetConnection();
      statusEl.textContent = "ğŸ” Finding partner...";
      statusEl.classList.remove("ringing");
      socket.emit("find-partner");
    };

    socket.on("waiting", msg => statusEl.textContent = msg);
    socket.on("status", msg => statusEl.textContent = msg);

    socket.on("partner-found", async ({ partnerId: id, partnerName }) => {
      partnerId = id;
      partnerEl.textContent = "Partner: " + partnerName;
      statusEl.textContent = "ğŸ“ Ringing...";
      statusEl.classList.add("ringing");
      await initPeer();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("signal", offer);
    });

    socket.on("signal", async data => {
      if (!pc) await initPeer();

      if (data.type === "offer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit("signal", answer);
        pendingCandidates.forEach(c => pc.addIceCandidate(new RTCIceCandidate(c)));
        pendingCandidates = [];
      } else if (data.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data));
        statusEl.textContent = "ğŸŸ¢ Connected";
        statusEl.classList.remove("ringing");
        btnEnd.disabled = false;
        btnMute.disabled = false;
        btnSpeaker.disabled = false;
        startTimer();
        pendingCandidates.forEach(c => pc.addIceCandidate(new RTCIceCandidate(c)));
        pendingCandidates = [];
      } else if (data.candidate) {
        if (pc && pc.remoteDescription) {
          await pc.addIceCandidate(new RTCIceCandidate(data));
        } else {
          pendingCandidates.push(data);
        }
      }
    });

    btnEnd.onclick = async () => {
      socket.emit("end-call");
      await resetConnection();
      statusEl.textContent = "âŒ Call ended. Click Find to reconnect.";
    };

    socket.on("call-ended", async () => {
      await resetConnection();
      statusEl.textContent = "ğŸ“´ Partner ended the call.";
    });

    socket.on("partner-left", async () => {
      await resetConnection();
      statusEl.textContent = "ğŸ”´ Partner disconnected.";
    });

    btnMute.onclick = () => {
      if (!localStream) return;
      isMuted = !isMuted;
      localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
      btnMute.classList.toggle("active", isMuted);
      btnMute.textContent = isMuted ? "ğŸ”‡ Mic Off" : "ğŸ¤ Mic On";
    };

    btnSpeaker.onclick = () => {
      speakerOn = !speakerOn;
      remoteAudio.muted = !speakerOn;
      btnSpeaker.classList.toggle("active", !speakerOn);
      btnSpeaker.textContent = speakerOn ? "ğŸ”Š Speaker On" : "ğŸ”ˆ Speaker Off";
    };
  </script>
</body>
</html>
