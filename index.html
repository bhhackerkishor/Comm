<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TalkPair</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(145deg, #1a1c1f, #0c0d0f);
      color: #fff;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px 40px;
      text-align: center;
      width: 360px;
      box-shadow: 0 4px 30px rgba(0,0,0,0.3);
    }
    h1 { margin-bottom: 15px; font-weight: 600; }
    input {
      width: 100%; padding: 10px 14px; border-radius: 8px;
      border: none; outline: none; font-size: 15px;
      margin-bottom: 15px; background: rgba(255,255,255,0.1);
      color: white;
    }
    .controls {
      display: flex; flex-wrap: wrap; justify-content: center;
      gap: 10px; margin-top: 10px;
    }
    button {
      background: rgba(255,255,255,0.1); color: white;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px; padding: 10px 16px; cursor: pointer;
      font-size: 14px; transition: all 0.25s ease; min-width: 90px;
    }
    button:hover { background: rgba(255,255,255,0.2); }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    button.active { background: #0f9d58; }
    button.danger { background: #d93025; }
    #status { margin-top: 15px; font-size: 14px; color: #aaa; min-height: 20px; }
    #partner { font-weight: 600; color: #00c3ff; margin-top: 8px; }
    .ringing { animation: blink 1s infinite; color: #ffb300; }
    @keyframes blink { 50% { opacity: 0.3; } }
    #timer { margin-top: 10px; font-size: 13px; color: #ccc; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üéôÔ∏è TalkPair</h1>
    <input id="name" placeholder="Enter your name" />
    <div class="controls">
      <button id="register">Register</button>
      <button id="find" disabled>Find</button>
      <button id="end" class="danger" disabled>End</button>
      <button id="mute" disabled>üé§ Mic</button>
      <button id="speaker" disabled>üîä Speaker</button>
    </div>
    <p id="partner"></p>
    <p id="status">Not connected</p>
    <p id="timer"></p>
  </div>

  <audio id="localAudio" autoplay muted></audio>
  <audio id="remoteAudio" autoplay></audio>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io("https://server-09p9.onrender.com");
    const nameInput = document.getElementById("name");
    const btnRegister = document.getElementById("register");
    const btnFind = document.getElementById("find");
    const btnEnd = document.getElementById("end");
    const btnMute = document.getElementById("mute");
    const btnSpeaker = document.getElementById("speaker");
    const statusEl = document.getElementById("status");
    const partnerEl = document.getElementById("partner");
    const timerEl = document.getElementById("timer");
    const localAudio = document.getElementById("localAudio");
    const remoteAudio = document.getElementById("remoteAudio");

    let pc, localStream, partnerId, isMuted = false, speakerOn = true, timer, callStart, isCaller = false;

    async function resetConnection() {
      if (pc) { pc.ontrack = null; pc.onicecandidate = null; pc.close(); pc = null; }
      if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
      partnerId = null;
      clearInterval(timer);
      timerEl.textContent = "";
      btnEnd.disabled = true;
      btnMute.disabled = true;
      btnSpeaker.disabled = true;
      btnMute.classList.remove("active");
      btnSpeaker.classList.remove("active");
      remoteAudio.srcObject = null;
      partnerEl.textContent = "";
      statusEl.classList.remove("ringing");
    }

    async function initPeer() {
      pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localAudio.srcObject = localStream;
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; };
      pc.onicecandidate = e => {
        if (e.candidate && partnerId) socket.emit("signal", { to: partnerId, data: e.candidate });
      };
    }

    function startTimer() {
      callStart = Date.now();
      timer = setInterval(() => {
        const diff = Math.floor((Date.now() - callStart) / 1000);
        const m = String(Math.floor(diff / 60)).padStart(2, "0");
        const s = String(diff % 60).padStart(2, "0");
        timerEl.textContent = `‚è±Ô∏è ${m}:${s}`;
      }, 1000);
    }

    btnRegister.onclick = () => {
      const name = nameInput.value.trim();
      if (!name) return alert("Enter name first");
      socket.emit("register", name);
      statusEl.textContent = "‚úÖ Registered as " + name;
      btnFind.disabled = false;
    };

    btnFind.onclick = async () => {
      await resetConnection();
      socket.emit("find-partner");
      statusEl.textContent = "üîç Finding partner...";
      isCaller = true;
    };

    socket.on("waiting", msg => statusEl.textContent = msg);

    socket.on("partner-found", async ({ partnerId: id, partnerName, initiator }) => {
      partnerId = id;
      partnerEl.textContent = "Partner: " + partnerName;
      statusEl.textContent = "üìû Connecting...";
      await initPeer();

      // only initiator creates offer
      if (initiator) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit("signal", { to: partnerId, data: offer });
      }
    });

    socket.on("signal", async ({ from, data }) => {
      if (!pc) await initPeer();
      partnerId = from;

      if (data.type === "offer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit("signal", { to: from, data: answer });
      } else if (data.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data));
        statusEl.textContent = "üü¢ Connected";
        btnEnd.disabled = false;
        btnMute.disabled = false;
        btnSpeaker.disabled = false;
        startTimer();
      } else if (data.candidate) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(data));
        } catch (e) {
          console.warn("ICE candidate error:", e);
        }
      }
    });

    btnEnd.onclick = async () => {
      socket.emit("end-call", { to: partnerId });
      await resetConnection();
      statusEl.textContent = "‚ùå Call ended. Click Find to reconnect.";
    };

    socket.on("call-ended", async () => {
      await resetConnection();
      statusEl.textContent = "üì¥ Partner ended the call.";
    });

    socket.on("partner-left", async () => {
      await resetConnection();
      statusEl.textContent = "üî¥ Partner disconnected.";
    });

    btnMute.onclick = () => {
      if (!localStream) return;
      isMuted = !isMuted;
      localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
      btnMute.classList.toggle("active", isMuted);
      btnMute.textContent = isMuted ? "üîá Mic Off" : "üé§ Mic On";
    };

    btnSpeaker.onclick = () => {
      speakerOn = !speakerOn;
      remoteAudio.muted = !speakerOn;
      btnSpeaker.classList.toggle("active", !speakerOn);
      btnSpeaker.textContent = speakerOn ? "üîä Speaker On" : "üîà Speaker Off";
    };
  </script>
</body>
</html>
